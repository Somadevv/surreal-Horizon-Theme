{% liquid
  assign product = closest.product
  assign namespace = section.settings.metafield_namespace | default: 'custom'
  assign show_icons = section.settings.show_icons
  assign is_collapsible = section.settings.is_collapsible
  assign default_collapsed = section.settings.default_collapsed
  assign placement = section.settings.placement | default: 'sidebar'

  case section.settings.content_width
    when 'content-center-aligned'
      assign content_width = 'page-width'
    when 'content-full-width'
      assign content_width = 'full-width'
  endcase

  assign summary_items = ''
  assign item_count = 0
  for block in section.blocks
    if block.settings.metafield_key != blank
      assign metafield_value = product.metafields[namespace][block.settings.metafield_key]
      if metafield_value != blank
        assign summary_items = summary_items | append: block.id | append: ','
        assign item_count = item_count | plus: 1
      endif
    endif
  endfor

  assign summary_array = summary_items | split: ','
  assign has_summary_items = false
  if summary_array.size > 1
    assign has_summary_items = true
  endif

  assign summary_class = 'product-summary'
  assign summary_class = summary_class | append: ' product-summary--' | append: placement
  
  if is_collapsible
    assign summary_class = summary_class | append: ' product-summary--collapsible'
    if default_collapsed
      assign summary_class = summary_class | append: ' product-summary--collapsed'
    endif
  endif
%}

{% if has_summary_items and product %}
  <div class="section-background color-{{ section.settings.color_scheme }}"></div>
  <div 
    class="product-summary-wrapper section section--{{ content_width }} spacing-style color-{{ section.settings.color_scheme }}"
    style="{% render 'spacing-style', settings: section.settings %}"
  >
    <div class="{{ summary_class }}" data-summary-placement="{{ placement }}">
      {% if section.settings.heading != blank %}
        <div class="product-summary__header">
          {% if is_collapsible %}
            <button 
              class="product-summary__toggle"
              type="button"
              aria-expanded="{% unless default_collapsed %}true{% else %}false{% endunless %}"
              aria-controls="product-summary-content"
            >
              <h3 class="product-summary__heading">{{ section.settings.heading }}</h3>
              <div class="product-summary__toggle-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6,9 12,15 18,9"></polyline>
                </svg>
              </div>
            </button>
          {% else %}
            <h3 class="product-summary__heading">{{ section.settings.heading }}</h3>
          {% endif %}
          
          {% if section.settings.description != blank %}
            <div class="product-summary__description rte">
              {{ section.settings.description }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      <div 
        class="product-summary__content"
        id="product-summary-content"
        {% if is_collapsible and default_collapsed %}style="display: none;"{% endif %}
      >
        <div class="product-summary__items">
          {% for block in section.blocks %}
            {% if block.settings.metafield_key != blank %}
              {% assign metafield_value = product.metafields[namespace][block.settings.metafield_key] %}
              {% if metafield_value != blank %}
                {% render 'summary-item',
                  metafield_key: block.settings.metafield_key,
                  metafield_value: metafield_value,
                  label: block.settings.label,
                  icon: block.settings.icon,
                  show_icons: show_icons,
                  placement: placement,
                  block_id: block.id
                %}
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>

        {% if section.settings.show_view_all_link and section.settings.view_all_text != blank %}
          <div class="product-summary__footer">
            <button 
              class="product-summary__view-all btn btn--text"
              type="button"
              data-view-all-metafields
            >
              {{ section.settings.view_all_text }}
            </button>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}

<script>
  // Toggle functionality for collapsible summary
  document.addEventListener('DOMContentLoaded', function() {
    const toggleButtons = document.querySelectorAll('.product-summary__toggle');
    
    toggleButtons.forEach(button => {
      button.addEventListener('click', function() {
        const content = this.closest('.product-summary').querySelector('.product-summary__content');
        const isExpanded = this.getAttribute('aria-expanded') === 'true';
        
        if (isExpanded) {
          this.setAttribute('aria-expanded', 'false');
          content.style.display = 'none';
          this.closest('.product-summary').classList.add('product-summary--collapsed');
        } else {
          this.setAttribute('aria-expanded', 'true');
          content.style.display = 'block';
          this.closest('.product-summary').classList.remove('product-summary--collapsed');
        }
      });
    });

    // View all metafields functionality
    const viewAllButtons = document.querySelectorAll('[data-view-all-metafields]');
    viewAllButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Scroll to main metafields section if it exists
        const metafieldsSection = document.querySelector('.product-metafields');
        if (metafieldsSection) {
          metafieldsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });
  });
</script>

{% stylesheet %}
  .product-summary {
    --summary-gap: 0.75rem;
  }

  .product-summary-wrapper {
    position: relative;
  }

  /* Placement styles */
  .product-summary--sidebar {
    max-width: 300px;
    background: rgba(var(--color-foreground), 0.02);
    border: 1px solid rgba(var(--color-foreground), 0.08);
    border-radius: 12px;
    padding: 1.25rem;
  }

  .product-summary--floating {
    position: fixed;
    top: 50%;
    right: 1rem;
    transform: translateY(-50%);
    max-width: 280px;
    background: rgb(var(--color-background));
    border: 1px solid rgba(var(--color-foreground), 0.12);
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
    z-index: 100;
  }

  .product-summary--above-fold {
    background: rgba(var(--color-foreground), 0.02);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }

  /* Header styles */
  .product-summary__header {
    margin-bottom: var(--summary-gap);
  }

  .product-summary__heading {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    line-height: 1.3;
  }

  .product-summary__description {
    margin: 0.5rem 0 0 0;
    font-size: 0.85rem;
    opacity: 0.8;
  }

  /* Toggle button for collapsible */
  .product-summary__toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    text-align: left;
  }

  .product-summary__toggle-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    transition: transform 0.2s ease;
  }

  .product-summary--collapsed .product-summary__toggle-icon {
    transform: rotate(-90deg);
  }

  .product-summary__toggle-icon svg {
    width: 100%;
    height: 100%;
  }

  /* Content area */
  .product-summary__content {
    transition: all 0.3s ease;
  }

  .product-summary__items {
    display: flex;
    flex-direction: column;
    gap: var(--summary-gap);
  }

  /* Footer */
  .product-summary__footer {
    margin-top: calc(var(--summary-gap) * 1.5);
    padding-top: var(--summary-gap);
    border-top: 1px solid rgba(var(--color-foreground), 0.08);
  }

  .product-summary__view-all {
    font-size: 0.85rem;
    text-decoration: underline;
    color: rgb(var(--color-link));
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  .product-summary__view-all:hover {
    text-decoration: none;
  }

  /* Responsive behavior */
  @media screen and (max-width: 1199px) {
    .product-summary--floating {
      position: relative;
      top: auto;
      right: auto;
      transform: none;
      max-width: none;
      margin: 1rem 0;
    }
  }

  @media screen and (max-width: 749px) {
    .product-summary--sidebar {
      max-width: none;
      padding: 1rem;
    }

    .product-summary {
      --summary-gap: 0.625rem;
    }

    .product-summary__heading {
      font-size: 1rem;
    }

    .product-summary__description {
      font-size: 0.8rem;
    }
  }

  /* Animation for floating placement */
  @media screen and (min-width: 1200px) {
    .product-summary--floating {
      animation: fadeInSlide 0.5s ease-out;
    }

    @keyframes fadeInSlide {
      from {
        opacity: 0;
        transform: translateY(-50%) translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
      }
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Product Summary",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Quick Info"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "text",
      "id": "metafield_namespace",
      "label": "Metafield Namespace",
      "default": "custom",
      "info": "The namespace for your product metafields"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "content_width",
      "label": "Content width",
      "options": [
        {
          "value": "content-center-aligned",
          "label": "Page"
        },
        {
          "value": "content-full-width",
          "label": "Full width"
        }
      ],
      "default": "content-center-aligned"
    },
    {
      "type": "select",
      "id": "placement",
      "label": "Placement style",
      "options": [
        {
          "value": "sidebar",
          "label": "Sidebar"
        },
        {
          "value": "above-fold",
          "label": "Above fold"
        },
        {
          "value": "floating",
          "label": "Floating (desktop only)"
        }
      ],
      "default": "sidebar"
    },
    {
      "type": "checkbox",
      "id": "is_collapsible",
      "label": "Make collapsible",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "default_collapsed",
      "label": "Start collapsed",
      "default": false,
      "info": "Only applies if collapsible is enabled"
    },
    {
      "type": "checkbox",
      "id": "show_icons",
      "label": "Show icons",
      "default": true
    },
    {
      "type": "header",
      "content": "View All Link"
    },
    {
      "type": "checkbox",
      "id": "show_view_all_link",
      "label": "Show 'View All' link",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View all text",
      "default": "View full details"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "summary_item",
      "name": "Summary Item",
      "settings": [
        {
          "type": "text",
          "id": "metafield_key",
          "label": "Metafield key",
          "info": "The key for the metafield (e.g., 'care_level', 'light_requirements')"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Display label",
          "info": "Custom label to display (leave blank to use metafield key)"
        },
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "options": [
            {
              "value": "",
              "label": "None"
            },
            {
              "value": "sun",
              "label": "Sun"
            },
            {
              "value": "water",
              "label": "Water"
            },
            {
              "value": "leaf",
              "label": "Leaf"
            },
            {
              "value": "ruler",
              "label": "Size"
            },
            {
              "value": "thermometer",
              "label": "Temperature"
            },
            {
              "value": "calendar",
              "label": "Time"
            },
            {
              "value": "heart",
              "label": "Care"
            },
            {
              "value": "info",
              "label": "Information"
            }
          ]
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Summary",
      "blocks": [
        {
          "type": "summary_item",
          "settings": {
            "metafield_key": "care_level",
            "label": "Care",
            "icon": "leaf"
          }
        },
        {
          "type": "summary_item",
          "settings": {
            "metafield_key": "light_requirements",
            "label": "Light",
            "icon": "sun"
          }
        },
        {
          "type": "summary_item",
          "settings": {
            "metafield_key": "watering_frequency",
            "label": "Water",
            "icon": "water"
          }
        }
      ]
    }
  ]
}
{% endschema %}