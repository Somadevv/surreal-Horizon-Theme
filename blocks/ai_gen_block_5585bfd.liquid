{% doc %}
  @prompt
    progress bar for customer cart amount. as they add to their cart they unlock discounts. allow me to input the discounts, price targets and names for each spend tier, add markers on progress bar to show the rewards on the progress bar, make the rewards equidistant on the progress bar and fill to the next one when spend = the reward amount, half fill the progress bar to the next reward to entice exra cart additions, but keep bar empty when cart empty, make the maximum spend amount to go to £500.00 but allow user to choose

{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-cart-progress-{{ ai_gen_id }} {
    background-color: {{ block.settings.background_color }};
    padding: 24px;
    border-radius: {{ block.settings.border_radius }}px;
    margin: 16px 0;
  }

  .ai-cart-progress__header-{{ ai_gen_id }} {
    text-align: center;
    margin-bottom: 20px;
  }

  .ai-cart-progress__title-{{ ai_gen_id }} {
    color: {{ block.settings.text_color }};
    font-size: {{ block.settings.title_size }}px;
    font-weight: 600;
    margin: 0 0 8px;
  }

  .ai-cart-progress__subtitle-{{ ai_gen_id }} {
    color: {{ block.settings.text_color }};
    font-size: {{ block.settings.subtitle_size }}px;
    margin: 0;
    opacity: 0.8;
  }

  .ai-cart-progress__bar-container-{{ ai_gen_id }} {
    position: relative;
    background-color: {{ block.settings.track_color }};
    height: {{ block.settings.bar_height }}px;
    border-radius: {{ block.settings.bar_height | divided_by: 2 }}px;
    overflow: hidden;
    margin: 20px 0;
  }

  .ai-cart-progress__bar-fill-{{ ai_gen_id }} {
    height: 100%;
    background: linear-gradient(90deg, {{ block.settings.progress_color_start }}, {{ block.settings.progress_color_end }});
    border-radius: {{ block.settings.bar_height | divided_by: 2 }}px;
    transition: width 0.6s ease;
    width: 0%;
  }

  .ai-cart-progress__markers-{{ ai_gen_id }} {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
  }

  .ai-cart-progress__marker-{{ ai_gen_id }} {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: {{ block.settings.marker_size }}px;
    height: {{ block.settings.marker_size }}px;
    background-color: {{ block.settings.marker_color }};
    border: 2px solid {{ block.settings.marker_border_color }};
    border-radius: 50%;
    z-index: 2;
    transition: all 0.3s ease;
  }

  .ai-cart-progress__marker-{{ ai_gen_id }}.achieved {
    background-color: {{ block.settings.marker_achieved_color }};
    border-color: {{ block.settings.marker_achieved_border_color }};
    transform: translate(-50%, -50%) scale(1.2);
  }

  .ai-cart-progress__marker-tooltip-{{ ai_gen_id }} {
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background-color: {{ block.settings.tooltip_bg_color }};
    color: {{ block.settings.tooltip_text_color }};
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 3;
  }

  .ai-cart-progress__marker-{{ ai_gen_id }}:hover .ai-cart-progress__marker-tooltip-{{ ai_gen_id }} {
    opacity: 1;
    visibility: visible;
  }

  .ai-cart-progress__current-status-{{ ai_gen_id }} {
    text-align: center;
    margin-top: 16px;
  }

  .ai-cart-progress__current-amount-{{ ai_gen_id }} {
    color: {{ block.settings.text_color }};
    font-size: {{ block.settings.amount_size }}px;
    font-weight: 600;
    margin: 0 0 4px;
  }

  .ai-cart-progress__next-reward-{{ ai_gen_id }} {
    color: {{ block.settings.text_color }};
    font-size: {{ block.settings.reward_text_size }}px;
    margin: 0;
    opacity: 0.8;
  }

  .ai-cart-progress__rewards-list-{{ ai_gen_id }} {
    margin-top: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
  }

  .ai-cart-progress__reward-item-{{ ai_gen_id }} {
    background-color: {{ block.settings.reward_item_bg }};
    color: {{ block.settings.reward_item_text }};
    padding: 8px 12px;
    border-radius: 16px;
    font-size: 12px;
    border: 1px solid {{ block.settings.reward_item_border }};
    transition: all 0.3s ease;
  }

  .ai-cart-progress__reward-item-{{ ai_gen_id }}.achieved {
    background-color: {{ block.settings.reward_achieved_bg }};
    color: {{ block.settings.reward_achieved_text }};
    border-color: {{ block.settings.reward_achieved_border }};
  }

  @media screen and (max-width: 749px) {
    .ai-cart-progress-{{ ai_gen_id }} {
      padding: 16px;
    }
    
    .ai-cart-progress__marker-tooltip-{{ ai_gen_id }} {
      font-size: 10px;
      padding: 4px 8px;
    }
  }
{% endstyle %}

<cart-progress-{{ ai_gen_id }}
  class="ai-cart-progress-{{ ai_gen_id }}"
  data-max-amount="{{ block.settings.max_amount | times: 100 }}"
  data-tier-1-amount="{{ block.settings.tier_1_amount | times: 100 }}"
  data-tier-1-name="{{ block.settings.tier_1_name | escape }}"
  data-tier-2-amount="{{ block.settings.tier_2_amount | times: 100 }}"
  data-tier-2-name="{{ block.settings.tier_2_name | escape }}"
  data-tier-3-amount="{{ block.settings.tier_3_amount | times: 100 }}"
  data-tier-3-name="{{ block.settings.tier_3_name | escape }}"
  data-tier-4-amount="{{ block.settings.tier_4_amount | times: 100 }}"
  data-tier-4-name="{{ block.settings.tier_4_name | escape }}"
  {{ block.shopify_attributes }}
>
  <div class="ai-cart-progress__header-{{ ai_gen_id }}">
    <h3 class="ai-cart-progress__title-{{ ai_gen_id }}">{{ block.settings.title }}</h3>
    <p class="ai-cart-progress__subtitle-{{ ai_gen_id }}">{{ block.settings.subtitle }}</p>
  </div>

  <div class="ai-cart-progress__bar-container-{{ ai_gen_id }}">
    <div class="ai-cart-progress__bar-fill-{{ ai_gen_id }}"></div>
    <div class="ai-cart-progress__markers-{{ ai_gen_id }}">
      <div class="ai-cart-progress__marker-{{ ai_gen_id }}" data-tier="1" style="left: 25%;">
        <div class="ai-cart-progress__marker-tooltip-{{ ai_gen_id }}">
          {{ block.settings.tier_1_amount | money }} - {{ block.settings.tier_1_name }}
        </div>
      </div>
      <div class="ai-cart-progress__marker-{{ ai_gen_id }}" data-tier="2" style="left: 50%;">
        <div class="ai-cart-progress__marker-tooltip-{{ ai_gen_id }}">
          {{ block.settings.tier_2_amount | money }} - {{ block.settings.tier_2_name }}
        </div>
      </div>
      <div class="ai-cart-progress__marker-{{ ai_gen_id }}" data-tier="3" style="left: 75%;">
        <div class="ai-cart-progress__marker-tooltip-{{ ai_gen_id }}">
          {{ block.settings.tier_3_amount | money }} - {{ block.settings.tier_3_name }}
        </div>
      </div>
      <div class="ai-cart-progress__marker-{{ ai_gen_id }}" data-tier="4" style="left: 100%;">
        <div class="ai-cart-progress__marker-tooltip-{{ ai_gen_id }}">
          {{ block.settings.tier_4_amount | money }} - {{ block.settings.tier_4_name }}
        </div>
      </div>
    </div>
  </div>

  <div class="ai-cart-progress__current-status-{{ ai_gen_id }}">
    <div class="ai-cart-progress__current-amount-{{ ai_gen_id }}">
      Cart Total: <span class="ai-cart-progress__amount-display-{{ ai_gen_id }}">{{ cart.total_price | money }}</span>
    </div>
    <div class="ai-cart-progress__next-reward-{{ ai_gen_id }}">
      <span class="ai-cart-progress__reward-message-{{ ai_gen_id }}">Add items to unlock rewards!</span>
    </div>
  </div>

  <div class="ai-cart-progress__rewards-list-{{ ai_gen_id }}">
    <div class="ai-cart-progress__reward-item-{{ ai_gen_id }}" data-tier="1">
      {{ block.settings.tier_1_amount | money }} - {{ block.settings.tier_1_name }}
    </div>
    <div class="ai-cart-progress__reward-item-{{ ai_gen_id }}" data-tier="2">
      {{ block.settings.tier_2_amount | money }} - {{ block.settings.tier_2_name }}
    </div>
    <div class="ai-cart-progress__reward-item-{{ ai_gen_id }}" data-tier="3">
      {{ block.settings.tier_3_amount | money }} - {{ block.settings.tier_3_name }}
    </div>
    <div class="ai-cart-progress__reward-item-{{ ai_gen_id }}" data-tier="4">
      {{ block.settings.tier_4_amount | money }} - {{ block.settings.tier_4_name }}
    </div>
  </div>
</cart-progress-{{ ai_gen_id }}>

<script>
  (function() {
    class CartProgress{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.maxAmount = parseInt(this.dataset.maxAmount);
        this.tiers = [
          { amount: parseInt(this.dataset.tier1Amount), name: this.dataset.tier1Name },
          { amount: parseInt(this.dataset.tier2Amount), name: this.dataset.tier2Name },
          { amount: parseInt(this.dataset.tier3Amount), name: this.dataset.tier3Name },
          { amount: parseInt(this.dataset.tier4Amount), name: this.dataset.tier4Name }
        ].filter(tier => tier.amount > 0).sort((a, b) => a.amount - b.amount);
        
        this.progressBar = this.querySelector('.ai-cart-progress__bar-fill-{{ ai_gen_id }}');
        this.amountDisplay = this.querySelector('.ai-cart-progress__amount-display-{{ ai_gen_id }}');
        this.rewardMessage = this.querySelector('.ai-cart-progress__reward-message-{{ ai_gen_id }}');
        this.markers = this.querySelectorAll('.ai-cart-progress__marker-{{ ai_gen_id }}');
        this.rewardItems = this.querySelectorAll('.ai-cart-progress__reward-item-{{ ai_gen_id }}');
      }

      connectedCallback() {
        this.updateProgress();
        this.setupCartListener();
      }

      setupCartListener() {
        document.addEventListener('cart:updated', () => {
          this.fetchCartAndUpdate();
        });

        window.addEventListener('storage', (e) => {
          if (e.key === 'cart') {
            this.updateProgress();
          }
        });

        this.fetchCartAndUpdate();
      }

      async fetchCartAndUpdate() {
        try {
          const response = await fetch('/cart.js');
          const cart = await response.json();
          this.updateProgressWithCart(cart);
        } catch (error) {
          console.error('Error fetching cart:', error);
        }
      }

      updateProgressWithCart(cart) {
        const cartTotal = cart.total_price;
        this.updateProgressBar(cartTotal);
        this.updateAmountDisplay(cartTotal);
        this.updateRewardMessage(cartTotal);
        this.updateMarkers(cartTotal);
        this.updateRewardItems(cartTotal);
      }

      updateProgress() {
        const cartTotal = window.cart ? window.cart.total_price : 0;
        this.updateProgressBar(cartTotal);
        this.updateRewardMessage(cartTotal);
        this.updateMarkers(cartTotal);
        this.updateRewardItems(cartTotal);
      }

      updateProgressBar(cartTotal) {
        if (cartTotal === 0) {
          this.progressBar.style.width = '0%';
          return;
        }

        const nextTier = this.tiers.find(tier => cartTotal < tier.amount);
        
        if (!nextTier) {
          this.progressBar.style.width = '100%';
          return;
        }

        const currentTierIndex = this.tiers.indexOf(nextTier);
        const previousTier = currentTierIndex > 0 ? this.tiers[currentTierIndex - 1] : { amount: 0 };
        
        const segmentStart = (currentTierIndex * 25);
        const segmentWidth = 25;
        const progressInSegment = (cartTotal - previousTier.amount) / (nextTier.amount - previousTier.amount);
        const halfProgressInSegment = Math.min(progressInSegment * 0.5, 0.5);
        
        const totalProgress = segmentStart + (segmentWidth * halfProgressInSegment);
        this.progressBar.style.width = Math.min(totalProgress, 100) + '%';
      }

      updateAmountDisplay(cartTotal) {
        if (this.amountDisplay) {
          this.amountDisplay.textContent = this.formatMoney(cartTotal);
        }
      }

      updateRewardMessage(cartTotal) {
        if (cartTotal === 0) {
          this.rewardMessage.textContent = 'Add items to unlock rewards!';
          return;
        }

        const nextTier = this.tiers.find(tier => cartTotal < tier.amount);
        
        if (!nextTier) {
          this.rewardMessage.textContent = 'Congratulations! You\'ve unlocked all rewards!';
        } else {
          const remaining = nextTier.amount - cartTotal;
          this.rewardMessage.textContent = `Spend ${this.formatMoney(remaining)} more to unlock: ${nextTier.name}`;
        }
      }

      updateMarkers(cartTotal) {
        this.markers.forEach((marker, index) => {
          const tier = this.tiers[index];
          if (tier && cartTotal >= tier.amount) {
            marker.classList.add('achieved');
          } else {
            marker.classList.remove('achieved');
          }
        });
      }

      updateRewardItems(cartTotal) {
        this.rewardItems.forEach((item, index) => {
          const tier = this.tiers[index];
          if (tier && cartTotal >= tier.amount) {
            item.classList.add('achieved');
          } else {
            item.classList.remove('achieved');
          }
        });
      }

      formatMoney(cents) {
        return new Intl.NumberFormat('en-GB', {
          style: 'currency',
          currency: 'GBP'
        }).format(cents / 100);
      }
    }

    customElements.define('cart-progress-{{ ai_gen_id }}', CartProgress{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Cart Progress Rewards",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Unlock Exclusive Rewards"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Spend more to unlock amazing discounts and perks"
    },
    {
      "type": "range",
      "id": "max_amount",
      "min": 100,
      "max": 500,
      "step": 50,
      "unit": "£",
      "label": "Maximum spend amount",
      "default": 500
    },
    {
      "type": "header",
      "content": "Reward Tier 1"
    },
    {
      "type": "range",
      "id": "tier_1_amount",
      "min": 0,
      "max": 500,
      "step": 5,
      "unit": "£",
      "label": "Spend amount",
      "default": 50
    },
    {
      "type": "text",
      "id": "tier_1_name",
      "label": "Reward name",
      "default": "5% Off"
    },
    {
      "type": "header",
      "content": "Reward Tier 2"
    },
    {
      "type": "range",
      "id": "tier_2_amount",
      "min": 0,
      "max": 500,
      "step": 5,
      "unit": "£",
      "label": "Spend amount",
      "default": 100
    },
    {
      "type": "text",
      "id": "tier_2_name",
      "label": "Reward name",
      "default": "10% Off"
    },
    {
      "type": "header",
      "content": "Reward Tier 3"
    },
    {
      "type": "range",
      "id": "tier_3_amount",
      "min": 0,
      "max": 500,
      "step": 5,
      "unit": "£",
      "label": "Spend amount",
      "default": 200
    },
    {
      "type": "text",
      "id": "tier_3_name",
      "label": "Reward name",
      "default": "15% Off + Free Shipping"
    },
    {
      "type": "header",
      "content": "Reward Tier 4"
    },
    {
      "type": "range",
      "id": "tier_4_amount",
      "min": 0,
      "max": 500,
      "step": 5,
      "unit": "£",
      "label": "Spend amount",
      "default": 300
    },
    {
      "type": "text",
      "id": "tier_4_name",
      "label": "Reward name",
      "default": "20% Off + Free Shipping + Gift"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#f8f9fa"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "track_color",
      "label": "Progress track color",
      "default": "#e9ecef"
    },
    {
      "type": "color",
      "id": "progress_color_start",
      "label": "Progress bar start color",
      "default": "#28a745"
    },
    {
      "type": "color",
      "id": "progress_color_end",
      "label": "Progress bar end color",
      "default": "#20c997"
    },
    {
      "type": "color",
      "id": "marker_color",
      "label": "Marker color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "marker_border_color",
      "label": "Marker border color",
      "default": "#dee2e6"
    },
    {
      "type": "color",
      "id": "marker_achieved_color",
      "label": "Achieved marker color",
      "default": "#28a745"
    },
    {
      "type": "color",
      "id": "marker_achieved_border_color",
      "label": "Achieved marker border color",
      "default": "#1e7e34"
    },
    {
      "type": "color",
      "id": "tooltip_bg_color",
      "label": "Tooltip background color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "tooltip_text_color",
      "label": "Tooltip text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "reward_item_bg",
      "label": "Reward item background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "reward_item_text",
      "label": "Reward item text",
      "default": "#6c757d"
    },
    {
      "type": "color",
      "id": "reward_item_border",
      "label": "Reward item border",
      "default": "#dee2e6"
    },
    {
      "type": "color",
      "id": "reward_achieved_bg",
      "label": "Achieved reward background",
      "default": "#d4edda"
    },
    {
      "type": "color",
      "id": "reward_achieved_text",
      "label": "Achieved reward text",
      "default": "#155724"
    },
    {
      "type": "color",
      "id": "reward_achieved_border",
      "label": "Achieved reward border",
      "default": "#c3e6cb"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Border radius",
      "default": 8
    },
    {
      "type": "range",
      "id": "bar_height",
      "min": 8,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Progress bar height",
      "default": 12
    },
    {
      "type": "range",
      "id": "marker_size",
      "min": 12,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Marker size",
      "default": 16
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 16,
      "max": 32,
      "step": 2,
      "unit": "px",
      "label": "Title size",
      "default": 20
    },
    {
      "type": "range",
      "id": "subtitle_size",
      "min": 12,
      "max": 18,
      "step": 1,
      "unit": "px",
      "label": "Subtitle size",
      "default": 14
    },
    {
      "type": "range",
      "id": "amount_size",
      "min": 16,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Amount text size",
      "default": 18
    },
    {
      "type": "range",
      "id": "reward_text_size",
      "min": 12,
      "max": 16,
      "step": 1,
      "unit": "px",
      "label": "Reward text size",
      "default": 14
    }
  ],
  "presets": [
    {
      "name": "Cart Progress Rewards"
    }
  ]
}
{% endschema %}